<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chess Game</title>
    <style>
        table { border-collapse: collapse; }
        td {
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 32px;
            cursor: pointer;
        }
        .white { background: #f0d9b5; }
        .black { background: #b58863; }
        .selected { outline: 3px solid red; }
    </style>
</head>
<body>
<h1>Chess Game</h1>

<table id="chessboard">
    <tbody>
    <tr th:each="row, rowStat : ${board}">
        <td th:each="cell, colStat : ${row}"
            th:data-row="${rowStat.index}"
            th:data-col="${colStat.index}"
            th:class="${(rowStat.index + colStat.index) % 2 == 0 ? 'white' : 'black'}"
            onclick="squareClicked(this)">
            <span th:text="${cell != null ? cell.symbol : ''}"></span>
        </td>
    </tr>
    </tbody>
</table>

<form id="moveForm" method="post" th:action="@{/move}" style="display:none;">
    <input type="hidden" name="fromRow" id="fromRow">
    <input type="hidden" name="fromCol" id="fromCol">
    <input type="hidden" name="toRow" id="toRow">
    <input type="hidden" name="toCol" id="toCol">
    <input type="hidden" name="promotionChoice" id="promotionChoice">
</form>

<script>
    let selectedSquare = null;

    function squareClicked(cell) {
        const row = parseInt(cell.getAttribute("data-row"));
        const col = parseInt(cell.getAttribute("data-col"));

        if (!selectedSquare) {
            // First click → select square
            selectedSquare = { row, col };
            cell.classList.add("selected");
        } else {
            // Second click → send move
            document.getElementById("fromRow").value = selectedSquare.row;
            document.getElementById("fromCol").value = selectedSquare.col;
            document.getElementById("toRow").value = row;
            document.getElementById("toCol").value = col;

            // ✅ Check if it's a pawn promotion
            const movingPiece = document.querySelector(
                `td[data-row='${selectedSquare.row}'][data-col='${selectedSquare.col}'] span`
            ).innerText;

            if ((movingPiece === "♙" && row === 0) || (movingPiece === "♟" && row === 7)) {
                // Ask player for promotion choice
                const choice = prompt("Promote pawn to (Queen, Rook, Bishop, Knight):", "Queen");
                document.getElementById("promotionChoice").value = choice ? choice.toUpperCase() : "QUEEN";
            }

            document.getElementById("moveForm").submit();
        }
    }
</script>

</body>
</html>
