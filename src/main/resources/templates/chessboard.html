<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chess Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }

        table {
            border-collapse: collapse;
            margin: 16px 0;
        }

        td {
            width: 70px;
            height: 70px;
            text-align: center;
            vertical-align: middle;
            font-size: 36px;
            cursor: pointer;
            user-select: none;
        }

        .white { background: #f0d9b5; }
        .black { background: #b58863; }
        .selected { outline: 3px solid #ff5252; }

        .topbar {
            display:flex;
            gap:20px;
            align-items:center;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            background:#eee;
            font-weight: bold;
        }

        .btn {
            padding: 6px 10px;
            border: 1px solid #444;
            background:#fff;
            cursor:pointer;
            border-radius:6px;
        }

        .btn:hover {
            background:#f2f2f2;
        }

        .msg {
            margin-top:8px;
            font-weight:bold;
            color:#333;
        }

        .check {
            background: #ff5252;
            color: white;
        }

        .in-check {
            background: #ff0000 !important;
            color: white;
        }

        .chat-bubble {
    position: absolute;
    background: #fff8c4;
    border: 1px solid #ccc;
    padding: 3px 6px;
    border-radius: 8px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 100;
    transform: translate(-50%, -120%);
    animation: fadeInOut 3s ease;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}


@keyframes floatUp {
    from { transform: translateY(0); opacity: 1; }
    to { transform: translateY(-40px); opacity: 0; }
}


    </style>
</head>
<body>
<div class="topbar">
    <div class="badge">Turn: <span th:text="${turn}">WHITE</span></div>
    <div class="badge check" th:if="${inCheck}">CHECK!</div>
    <form th:action="@{/reset}" method="get" style="margin:0;">
        <button class="btn" type="submit">Reset</button>
    </form>
</div>

<!-- ‚úÖ Add game result messages -->
<div class="msg" th:if="${checkmate}">
    <span th:text="${winner + ' Wins by Checkmate!'}"></span>
</div>

<div class="msg" th:if="${stalemate}">
    <span>ü§ù Stalemate - It's a Draw!</span>
</div>

<div class="msg" th:if="${moveOk != null}">
    <span th:text="${moveOk} ? '‚úÖ Move accepted' : '‚ùå Invalid move'"></span>
</div>

<table id="chessboard">
    <tbody>
    <tr th:each="row, rowStat : ${board}">
        <td th:each="cell, colStat : ${row}"
            th:attr="data-row=${rowStat.index},data-col=${colStat.index}"
            th:class="${(rowStat.index + colStat.index) % 2 == 0 ? 'white' : 'black'}"
            onclick="squareClicked(this)">
            <span th:text="${cell != null ? cell.symbol : ''}"></span>
        </td>
    </tr>
    </tbody>
</table>

<form id="moveForm" method="post" th:action="@{/move}" style="display:none;">
    <input type="hidden" name="fromRow" id="fromRow">
    <input type="hidden" name="fromCol" id="fromCol">
    <input type="hidden" name="toRow" id="toRow">
    <input type="hidden" name="toCol" id="toCol">
    <input type="hidden" name="promotionChoice" id="promotionChoice">
</form>

<script>
    let selectedCell = null;

    function clearSelection() {
        if (selectedCell) {
            selectedCell.classList.remove("selected");
            selectedCell = null;
        }
    }

    function squareClicked(cell) {
        const row = parseInt(cell.getAttribute("data-row"));
        const col = parseInt(cell.getAttribute("data-col"));

        if (!selectedCell) {
            selectedCell = cell;
            selectedCell.classList.add("selected");
            return;
        }

        const fromRow = parseInt(selectedCell.getAttribute("data-row"));
        const fromCol = parseInt(selectedCell.getAttribute("data-col"));
        const toRow = row;
        const toCol = col;

        const movingSymbol = selectedCell.querySelector("span")?.innerText || "";
        let promotionChoice = "";

        if ((movingSymbol === "‚ôô" && toRow === 0) || (movingSymbol === "‚ôü" && toRow === 7)) {
            const choice = prompt("Promote pawn to (Queen, Rook, Bishop, Knight):", "Queen");
            promotionChoice = (choice || "Queen").toUpperCase();
        }

        clearSelection();

        // AJAX request
        fetch('/move', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                fromRow, fromCol, toRow, toCol, promotionChoice
            })
        })
        .then(res => res.json())
        .then(data => updateBoard(data))
        .catch(err => console.error(err));
    }

    function updateBoard(data) {
    const boardTable = document.getElementById("chessboard");
    const board = data.board;

    for (let r = 0; r < 8; r++) {
        const row = boardTable.rows[r];
        for (let c = 0; c < 8; c++) {
            const cell = row.cells[c];
            const piece = board[r][c];
            cell.querySelector("span").innerText = piece ? piece.symbol : "";
            cell.classList.remove("in-check"); // reset previous check highlights
        }
    }

    document.querySelector(".badge span").innerText = data.turn;

    // Update messages
    document.querySelectorAll(".msg").forEach(el => el.remove());
    if (data.checkmate) {
        const msg = document.createElement("div");
        msg.className = "msg";
        msg.innerText = `${data.winner} Wins by Checkmate!`;
        document.body.insertBefore(msg, boardTable);
    } else if (data.stalemate) {
        const msg = document.createElement("div");
        msg.className = "msg";
        msg.innerText = "ü§ù Stalemate - It's a Draw!";
        document.body.insertBefore(msg, boardTable);
    }

    if (data.inCheck && data.kingRow !== undefined && data.kingCol !== undefined) {
        const msg = document.createElement("div");
        msg.className = "msg";
        msg.innerText = `${data.turn} KING IS IN CHECK!`;
        document.body.insertBefore(msg, boardTable);
        const kingCell = boardTable.rows[data.kingRow].cells[data.kingCol];
        kingCell.classList.add("in-check");
    }

    // ‚úÖ Trigger pawn chat after every board update
    console.log("Running pawn chat check...");
    makePawnsChat(boardTable);  // <-- FIXED
}



    function makePawnsChat(boardTable) {
    const pawns = [];
    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            const cell = boardTable.rows[r].cells[c];
            if (cell.innerText === "‚ôô" || cell.innerText === "‚ôü") {
                pawns.push({ r, c });
            }
        }
    }

    // pick two same-color pawns
    for (let i = 0; i < pawns.length; i++) {
        for (let j = i + 1; j < pawns.length; j++) {
            const p1 = pawns[i], p2 = pawns[j];
            if (boardTable.rows[p1.r].cells[p1.c].innerText === boardTable.rows[p2.r].cells[p2.c].innerText) {
                triggerPawnChat(boardTable, p1.r, p1.c, p2.r, p2.c);
                return; // only one pair chats
            }
        }
    }
}

function triggerPawnChat(boardTable, r1, c1, r2, c2) {
    const pawn1 = boardTable.rows[r1].cells[c1];
    const pawn2 = boardTable.rows[r2].cells[c2];

    const dialogues = [
        ["Hi üëã", "Hello! How are you?"],
        ["Stay strong!", "You too, brother!"],
        ["We guard the king!", "Always!"],
        ["Long march ahead...", "But we‚Äôll make it!"],
        ["Ready?", "Always ready!"]
    ];

    const [msg1, msg2] = dialogues[Math.floor(Math.random() * dialogues.length)];

    showChatBubble(pawn1, msg1);
    setTimeout(() => showChatBubble(pawn2, msg2), 1500);
}


function showChatBubble(cell, text) {
    const bubble = document.createElement("div");
    bubble.className = "chat-bubble";
    bubble.innerText = text;
    cell.appendChild(bubble);

    setTimeout(() => bubble.remove(), 3000); // disappears after 3s
}



</script>

</body>
</html>
