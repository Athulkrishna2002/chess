<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chess Game</title>
    <style>
        table { border-collapse: collapse; margin: 12px 0; }
        td {
            width: 60px; height: 60px; text-align: center; vertical-align: middle;
            font-size: 32px; cursor: pointer; user-select: none;
        }
        .white { background: #f0d9b5; }
        .black { background: #b58863; }
        .selected { outline: 3px solid #ff5252; }
        .topbar { display:flex; gap:12px; align-items:center; }
        .badge { padding: 4px 8px; border-radius: 8px; background:#eee; font-family: sans-serif; }
        .btn { padding: 6px 10px; border: 1px solid #444; background:#fff; cursor:pointer; border-radius:6px; }
        .msg { font-family:sans-serif; margin-top:8px; }
    </style>
</head>
<body>
<div class="topbar">
    <div class="badge">Turn: <span th:text="${turn}">WHITE</span></div>
    <div class="badge" th:if="${inCheck}">CHECK!</div>
    <form th:action="@{/reset}" method="get" style="margin:0;">
        <button class="btn" type="submit">Reset</button>
    </form>
</div>

<div class="msg" th:if="${moveOk != null}">
    <span th:text="${moveOk} ? 'Move accepted' : 'Invalid move'"></span>
</div>

<table id="chessboard">
    <tbody>
    <tr th:each="row, rowStat : ${board}">
        <td th:each="cell, colStat : ${row}"
            th:attr="data-row=${rowStat.index},data-col=${colStat.index}"
            th:class="${(rowStat.index + colStat.index) % 2 == 0 ? 'white' : 'black'}"
            onclick="squareClicked(this)">
            <span th:text="${cell != null ? cell.symbol : ''}"></span>
        </td>
    </tr>
    </tbody>
</table>

<form id="moveForm" method="post" th:action="@{/move}" style="display:none;">
    <input type="hidden" name="fromRow" id="fromRow">
    <input type="hidden" name="fromCol" id="fromCol">
    <input type="hidden" name="toRow" id="toRow">
    <input type="hidden" name="toCol" id="toCol">
    <input type="hidden" name="promotionChoice" id="promotionChoice">
</form>

<script>
    let selectedCell = null;

    function clearSelection() {
        if (selectedCell) {
            selectedCell.classList.remove("selected");
            selectedCell = null;
        }
    }

    function squareClicked(cell) {
        const row = parseInt(cell.getAttribute("data-row"));
        const col = parseInt(cell.getAttribute("data-col"));

        if (!selectedCell) {
            // First click — select
            selectedCell = cell;
            selectedCell.classList.add("selected");
            return;
        }

        // Second click — submit move
        document.getElementById("fromRow").value = parseInt(selectedCell.getAttribute("data-row"));
        document.getElementById("fromCol").value = parseInt(selectedCell.getAttribute("data-col"));
        document.getElementById("toRow").value = row;
        document.getElementById("toCol").value = col;

        // Detect pawn promotion by reading the symbol from the source square
        const movingSymbol = selectedCell.querySelector("span")?.innerText || "";

        // White pawn (♙) reaching rank 0, Black pawn (♟) reaching rank 7
        if ((movingSymbol === "♙" && row === 0) || (movingSymbol === "♟" && row === 7)) {
            const choice = prompt("Promote pawn to (Queen, Rook, Bishop, Knight):", "Queen");
            document.getElementById("promotionChoice").value = (choice || "Queen").toUpperCase();
        } else {
            document.getElementById("promotionChoice").value = ""; // not promoting
        }

        clearSelection();
        document.getElementById("moveForm").submit();
    }

    // Deselect if user clicks outside the board
    document.addEventListener('click', (e) => {
        const board = document.getElementById('chessboard');
        if (!board.contains(e.target)) clearSelection();
    });
</script>
</body>
</html>
